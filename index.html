<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MUSAWI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220; --text:#eef2ff; --muted:#d1d5db;
      --card:rgba(255,255,255,.10); --border:rgba(255,255,255,.18);
      --shadow:0 18px 40px rgba(0,0,0,.38);
      --glass:rgba(255,255,255,.07);
      --accent:rgba(34,197,94,.95);
    }
    body.light{
      --bg:#f4f6ff; --text:#0b1220; --muted:#334155;
      --card:rgba(0,0,0,.06); --border:rgba(0,0,0,.12);
      --shadow:0 18px 40px rgba(0,0,0,.12);
      --glass:rgba(255,255,255,.70);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Cairo",system-ui,Arial;
      color:var(--text); background:var(--bg);
      min-height:100vh; overflow-x:hidden;
      padding:150px 14px 18px;
    }

    /* BG Video */
    .bgVideo{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-3;transform:scale(1.02)}
    .overlay{
      position:fixed; inset:0; z-index:-2;
      background:
        radial-gradient(900px 520px at 80% 20%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(750px 450px at 20% 80%, rgba(59,130,246,.12), transparent 55%),
        linear-gradient(120deg, rgba(11,18,32,.28), rgba(11,18,32,.16));
    }
    body.light .overlay{
      background:
        radial-gradient(900px 520px at 80% 20%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(750px 450px at 20% 80%, rgba(59,130,246,.14), transparent 55%),
        linear-gradient(120deg, rgba(255,255,255,.30), rgba(255,255,255,.18));
    }

    /* Top HUD */
    .topHUD{
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      width:min(980px, calc(100% - 20px)); z-index:50; pointer-events:none;
    }
    .timeBig{ text-align:center; font-weight:900; font-size:64px; line-height:1; text-shadow:none; }
    .hudRow{
      margin-top:10px; pointer-events:auto;
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:var(--glass); backdrop-filter:blur(10px);
      font-weight:900; font-size:14px;
    }
    body.light .hudRow{border-color:rgba(0,0,0,.10)}

    @media (max-width:560px){
      body{padding-top:170px}
      .timeBig{font-size:54px}
      .hudRow{font-size:13px}
    }

    .grid{
      width:min(980px,100%); margin:0 auto;
      display:grid; gap:16px; grid-template-columns:1.2fr .8fr;
    }
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:18px; padding:18px; box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }

    .hero{display:flex;gap:14px;align-items:flex-start}
    .photo{width:92px;height:92px;border-radius:20px;border:1px solid var(--border);object-fit:cover;margin-top:2px}
    h1{margin:0;font-size:32px;font-weight:900}
    .subtitle{margin:8px 0 0;color:var(--muted);font-weight:900;font-size:18px}

    .sectionTitle{margin:0 0 10px;font-size:18px;font-weight:900}
    .bigNote{
      margin:0; padding:14px 16px; border-radius:16px;
      border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.05);
      font-weight:900; font-size:21px; line-height:2.1;
    }
    body.light .bigNote{border-color:rgba(0,0,0,.10);background:rgba(0,0,0,.03)}

    /* YouTube */
    .video{border-radius:16px;overflow:hidden;border:1px solid var(--border);aspect-ratio:16/9;background:rgba(0,0,0,.20)}
    .video iframe{width:100%;height:100%;border:0;display:block}

    /* Player */
    .audioTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.06)
    }
    body.light .audioTop{background:rgba(0,0,0,.03)}
    .navBtns{display:flex;gap:8px}
    .btn{
      border:1px solid var(--border); background:rgba(255,255,255,.10);
      color:var(--text); padding:10px 12px; border-radius:14px;
      font-weight:900; cursor:pointer; font-family:inherit;
      white-space:nowrap;
    }
    .trackTitle{margin:0;flex:1;text-align:right;font-size:13px;font-weight:900;color:var(--muted)}
    .volWrap{
      margin-top:10px;display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.06)
    }
    body.light .volWrap{background:rgba(0,0,0,.03)}
    .volLabel{font-weight:900;font-size:13px;color:var(--muted);white-space:nowrap}
    .volume{width:100%;accent-color:var(--accent)}
    .vizWrap{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05)}
    #viz{width:100%;height:120px;display:block}

    .socialRow{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .socLink{
      flex:1 1 180px; text-decoration:none; color:var(--text);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,.06); font-weight:900;
    }
    .socLeft{display:flex;align-items:center;gap:10px}
    .socIco{width:34px;height:34px;border-radius:12px;display:grid;place-items:center;border:1px solid var(--border);background:rgba(255,255,255,.10)}

    footer{
      width:min(980px,100%); margin:16px auto 0;
      text-align:center; font-weight:900; font-size:14px;
      padding:12px;border-radius:18px;border:1px solid var(--border);
      background:rgba(255,255,255,.06)
    }

    .nightToggle{
      position:fixed; left:12px; bottom:12px; z-index:60;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08); backdrop-filter:blur(10px);
    }
    .nightLabel{font-weight:900;font-size:13px}
  </style>
</head>

<body>
  <!-- BG -->
  <video class="bgVideo" id="bgVideo" autoplay muted loop playsinline>
    <source id="bgSource" src="" type="video/mp4">
  </video>
  <div class="overlay" id="overlay"></div>

  <!-- Top HUD -->
  <div class="topHUD">
    <div class="timeBig" id="timeNow">--:--</div>
    <div class="hudRow">
      <span id="dateTxt">...</span>
      <span id="wxTxt">...</span>
    </div>
  </div>

  <main class="grid">
    <!-- Profile -->
    <section class="card">
      <div class="hero">
        <img class="photo" id="avatar" src="" alt="صورتي">
        <div style="flex:1">
          <h1 id="name">MUSAWI</h1>
          <p class="subtitle" id="subtitle">...</p>
          <h2 class="sectionTitle" style="margin-top:14px" id="noteTitle">كلمة</h2>
          <p class="bigNote" id="mainQuote">... تحميل</p>
        </div>
      </div>

      <div class="socialRow" id="socialRow"></div>
    </section>

    <!-- Media -->
    <section class="card">
      <h2 class="sectionTitle" id="ytTitle">YouTube</h2>
      <div class="video">
        <iframe id="ytFrame" src="" title="YouTube"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.14); margin:14px 0;">

      <h2 class="sectionTitle">Music</h2>
      <div class="audioTop">
        <div class="navBtns">
          <button class="btn" id="prevTrack">◀</button>
          <button class="btn" id="nextTrack">▶</button>
        </div>
        <p class="trackTitle" id="trackTitle">...</p>
        <button class="btn" id="audioBtn">تشغيل</button>
      </div>

      <div class="volWrap">
        <span class="volLabel">خفض الصوت</span>
        <input class="volume" id="volume" type="range" min="0" max="100" value="70">
      </div>

      <div class="vizWrap"><canvas id="viz"></canvas></div>

      <audio id="bgAudio" preload="metadata" crossorigin="anonymous"></audio>
    </section>
  </main>

  <footer>© <span id="y"></span> — <span id="footerAyah">إِنَّ مَعَ الْعُسْرِ يُسْرًا</span></footer>

  <div class="nightToggle">
    <span class="nightLabel">الوضع الليلي</span>
    <button class="btn" id="toggleTheme">تشغيل/إطفاء</button>
  </div>

  <script>
  /* =========================
     SETTINGS (تعديل سريع)
  ========================= */
  const SETTINGS = {
    files: { bgVideo: "bg.mp4.mp4", avatar: "avatar.jpg" },
    profile: { name: "MUSAWI", subtitle: "طالب GEOLOGY — جامعة البصرة", noteTitle: "كلمة" },
    social: [
      { label:"Telegram", url:"https://t.me/Mu29_iq", icon:"telegram" },
      { label:"Instagram", url:"https://www.instagram.com/mu29__/", icon:"instagram" }
    ],
    youtube: { title:"صورة موسيقى", embed:"https://www.youtube.com/embed/BXChU6bMEXU" },
    note: {
      sheetCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXkdu2p1KVIjDPGdb97HfmkKa2WuvKN349Z5qdZOd_RTCyT__xNLL44swa0EUAnq614hxS9p52NSlL/pub?gid=0&single=true&output=csv"
    },
    footerAyah: "إِنَّ مَعَ الْعُسْرِ يُسْرًا",
    basra: { lat: 30.5085, lon: 47.7804 },

    audio: {
      album: [ // ✅ للاستماع العادي فقط (بدون eleven)
        { title:"Track 1", file:"audio.mp3.mp3.mp3" },
        { title:"Track 2", file:"audio1.mp3.mp3" }
      ],
      defaults: { startIndex:0, volume:70, loop:true }
    },

    event1111: { // ✅ منفصل 100%
      enabled: true,
      times: ["11:11", "23:11"],
      durationMs: 60000,
      track: { title:"11:11 Special", file:"eleven.mp3.mp3" }
    }
  };

  /* =========================
     MODULE: BG
  ========================= */
  (function BG(){
    const src = document.getElementById("bgSource");
    const vid = document.getElementById("bgVideo");
    if(!src||!vid) return;
    src.src = SETTINGS.files.bgVideo;
    vid.load();
  })();

  /* =========================
     MODULE: PROFILE + SOCIAL + NOTE + YOUTUBE + FOOTER
  ========================= */
  (function UI(){
    const avatar=document.getElementById("avatar");
    const nameEl=document.getElementById("name");
    const subtitle=document.getElementById("subtitle");
    const noteTitle=document.getElementById("noteTitle");
    const quoteEl=document.getElementById("mainQuote");
    const ytTitle=document.getElementById("ytTitle");
    const ytFrame=document.getElementById("ytFrame");
    const footerAyah=document.getElementById("footerAyah");
    const socialRow=document.getElementById("socialRow");

    if(avatar) avatar.src=SETTINGS.files.avatar;
    if(nameEl) nameEl.textContent=SETTINGS.profile.name;
    if(subtitle) subtitle.textContent=SETTINGS.profile.subtitle;
    if(noteTitle) noteTitle.textContent=SETTINGS.profile.noteTitle;
    if(ytTitle) ytTitle.textContent=SETTINGS.youtube.title;
    if(ytFrame) ytFrame.src=SETTINGS.youtube.embed;
    if(footerAyah) footerAyah.textContent=SETTINGS.footerAyah;

    const ICON = {
      telegram:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21.8 4.3c.3-1.2-.9-2-2-1.6L3.7 8.9c-1.1.4-1.1 2 .1 2.3l4.1 1.2 1.6 5c.3 1 1.6 1.3 2.4.6l2.3-2.1 4 3c.9.7 2.2.2 2.5-.9L21.8 4.3Z" fill="currentColor" opacity=".95"/></svg>`,
      instagram:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7.5 2h9A5.5 5.5 0 0 1 22 7.5v9A5.5 5.5 0 0 1 16.5 22h-9A5.5 5.5 0 0 1 2 16.5v-9A5.5 5.5 0 0 1 7.5 2Z" stroke="currentColor" stroke-width="2" opacity=".95"/><path d="M12 16.1A4.1 4.1 0 1 0 12 8a4.1 4.1 0 0 0 0 8.1Z" stroke="currentColor" stroke-width="2"/></svg>`
    };

    if(socialRow){
      socialRow.innerHTML="";
      SETTINGS.social.forEach(s=>{
        const a=document.createElement("a");
        a.className="socLink";
        a.href=s.url; a.target="_blank"; a.rel="noopener";
        a.innerHTML=`<span class="socLeft"><span class="socIco">${ICON[s.icon]||""}</span>${s.label}</span><span>↗</span>`;
        socialRow.appendChild(a);
      });
    }

    // note from sheet (B1)
    if(quoteEl && SETTINGS.note.sheetCsvUrl){
      fetch(SETTINGS.note.sheetCsvUrl,{cache:"no-store"})
        .then(r=>r.text())
        .then(t=>{
          t=t.replace(/^\uFEFF/,"");
          const i=t.indexOf(",");
          if(i===-1) return;
          const v=t.slice(i+1).trim().replace(/^"|"$/g,"");
          if(v) quoteEl.textContent=v;
        })
        .catch(()=>{});
    }

    // year
    document.getElementById("y").textContent = new Date().getFullYear();
  })();

  /* =========================
     MODULE: THEME
  ========================= */
  (function THEME(){
    const btn = document.getElementById("toggleTheme");
    const saved = localStorage.getItem("themeMode");
    if(saved==="light") document.body.classList.add("light");
    if(!btn) return;
    btn.addEventListener("click", ()=>{
      document.body.classList.toggle("light");
      localStorage.setItem("themeMode", document.body.classList.contains("light") ? "light" : "dark");
    });
  })();

  /* =========================
     MODULE: CLOCK + DATE
  ========================= */
  function iraqHHMM(){
    return new Intl.DateTimeFormat("en-GB",{timeZone:"Asia/Baghdad",hour:"2-digit",minute:"2-digit",hour12:false}).format(new Date());
  }
  function iraqDate(){
    return new Intl.DateTimeFormat("ar-IQ",{timeZone:"Asia/Baghdad",weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(new Date());
  }

  /* =========================
     MODULE: WEATHER (Basra)
  ========================= */
  async function fetchWeather(){
    const wxTxt=document.getElementById("wxTxt");
    try{
      const {lat,lon}=SETTINGS.basra;
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m&timezone=Asia%2FBaghdad`;
      const r=await fetch(url,{cache:"no-store"});
      const d=await r.json();
      wxTxt.textContent=`البصرة: ${Math.round(d.current.temperature_2m)}°`;
    }catch{
      wxTxt.textContent="طقس البصرة غير متاح";
    }
  }

  function tickHUD(){
    document.getElementById("timeNow").textContent = iraqHHMM();
    document.getElementById("dateTxt").textContent = iraqDate();
  }

  tickHUD();
  fetchWeather();
  setInterval(tickHUD, 1000);
  setInterval(fetchWeather, 10*60*1000);

  /* =========================
     MODULE: AUDIO (Album only) + Visualizer
  ========================= */
  (function AUDIO(){
    const audioEl=document.getElementById("bgAudio");
    const btn=document.getElementById("audioBtn");
    const vol=document.getElementById("volume");
    const titleEl=document.getElementById("trackTitle");
    const prev=document.getElementById("prevTrack");
    const next=document.getElementById("nextTrack");
    const canvas=document.getElementById("viz");
    const ctx=canvas.getContext("2d");

    const tracks=SETTINGS.audio.album;
    const defaults=SETTINGS.audio.defaults;

    let idx=0, playing=false, inEvent=false, lastKey=null;
    let saved=null;

    let audioCtx=null, analyser=null, srcNode=null, data=null, raf=null;

    function setTrack(i){
      if(!tracks.length){ titleEl.textContent="لا يوجد مقاطع"; return; }
      idx=(i+tracks.length)%tracks.length;
      audioEl.src = tracks[idx].file;
      audioEl.loop = !!defaults.loop;
      titleEl.textContent = `المقطع: ${idx+1} — ${tracks[idx].title}`;
      audioEl.load();
    }

    vol.value=String(defaults.volume??70);
    audioEl.volume=(Number(vol.value)||70)/100;
    vol.addEventListener("input", ()=> audioEl.volume=(Number(vol.value)||0)/100);

    function resize(){
      const dpr=window.devicePixelRatio||1;
      const r=canvas.getBoundingClientRect();
      canvas.width=Math.floor(r.width*dpr);
      canvas.height=Math.floor(r.height*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    function ensureGraph(){
      if(audioCtx) return;
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize=2048;
      analyser.smoothingTimeConstant=0.82;
      data = new Uint8Array(analyser.frequencyBinCount);
      srcNode = audioCtx.createMediaElementSource(audioEl);
      srcNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }

    function stopViz(){
      if(raf) cancelAnimationFrame(raf);
      raf=null;
      const w=canvas.getBoundingClientRect().width;
      const h=canvas.getBoundingClientRect().height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="rgba(255,255,255,0.03)";
      ctx.fillRect(0,0,w,h);
    }

    function drawBars(){
      const w=canvas.getBoundingClientRect().width;
      const h=canvas.getBoundingClientRect().height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="rgba(255,255,255,0.03)";
      ctx.fillRect(0,0,w,h);

      analyser.getByteFrequencyData(data);
      const bars=64, step=Math.floor(data.length/bars), barW=w/bars;
      for(let i=0;i<bars;i++){
        const v=data[i*step]/255;
        const barH=Math.max(6, v*(h-12));
        ctx.fillStyle="rgba(255,255,255,0.80)";
        ctx.fillRect(i*barW+barW*0.18, h-barH, barW*0.64, barH);
      }
      raf=requestAnimationFrame(drawBars);
    }

    async function play(){
      ensureGraph();
      if(audioCtx.state==="suspended") await audioCtx.resume();
      await audioEl.play(); // iPhone: لازم ضغط زر
      playing=true;
      btn.textContent="إيقاف";
      drawBars();
    }
    function pause(){
      audioEl.pause();
      playing=false;
      btn.textContent="تشغيل";
      stopViz();
    }

    btn.addEventListener("click", async()=>{
      try{
        if(!playing) await play();
        else pause();
      }catch{
        btn.textContent="اضغط مرة ثانية";
      }
    });

    prev.addEventListener("click", async()=>{
      if(inEvent) return;
      const was=playing; if(was) pause();
      setTrack(idx-1);
      if(was) await play();
    });

    next.addEventListener("click", async()=>{
      if(inEvent) return;
      const was=playing; if(was) pause();
      setTrack(idx+1);
      if(was) await play();
    });

    function fadeTo(target, ms=700){
      const start=audioEl.volume, t0=performance.now();
      return new Promise(res=>{
        function step(t){
          const p=Math.min(1,(t-t0)/ms);
          audioEl.volume = start + (target-start)*p;
          p<1 ? requestAnimationFrame(step) : res();
        }
        requestAnimationFrame(step);
      });
    }

    async function startEvent(){
      if(inEvent || !SETTINGS.event1111.enabled) return;
      inEvent=true;

      saved = { src: audioEl.src, time: audioEl.currentTime||0, was: playing, vol: (Number(vol.value)||70)/100 };

      try{
        if(saved.was){
          await fadeTo(Math.min(saved.vol, 0.18), 700);
          pause();
        }

        audioEl.src = SETTINGS.event1111.track.file;
        audioEl.loop = false;
        audioEl.load();
        titleEl.textContent = `✨ 11:11 — ${SETTINGS.event1111.track.title}`;

        if(saved.was) await play();

        setTimeout(endEvent, SETTINGS.event1111.durationMs || 60000);
      }catch{
        endEvent();
      }
    }

    async function endEvent(){
      if(!inEvent) return;
      try{
        if(playing) pause();

        inEvent=false;
        audioEl.src = saved.src;
        audioEl.load();
        audioEl.currentTime = saved.time||0;

        vol.value = String(Math.round(saved.vol*100));
        audioEl.volume = saved.vol;

        // يرجّع عنوان الألبوم الصحيح
        titleEl.textContent = `المقطع: ${idx+1} — ${tracks[idx].title}`;

        if(saved.was){
          await play();
          await fadeTo(saved.vol, 900);
        }
      } finally {
        saved=null;
      }
    }

    // 11:11 check (no repeat)
    function check1111(){
      const t = iraqHHMM();
      if(!(SETTINGS.event1111.times||[]).includes(t)) return;

      const key = new Intl.DateTimeFormat("en-CA",{
        timeZone:"Asia/Baghdad",year:"numeric",month:"2-digit",day:"2-digit",
        hour:"2-digit",minute:"2-digit",hour12:false
      }).format(new Date());

      if(lastKey===key) return;
      lastKey=key;
      startEvent();
    }

    setInterval(check1111, 1000);

    // init
    setTrack(defaults.startIndex||0);
    stopViz();
  })();
  </script>
</body>
</html>
